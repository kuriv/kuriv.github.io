# 对象复制

在多数情况下，我们并不需要完全复制一个对象来获得其中属性。但有一个情况下确实需要：如果你有一个 GTK 窗口对象，该对象持有窗口相关的资源。你可能会想复制一个新的窗口，保持所有属性与原来的窗口相同，但必须是一个新的对象（因为如果不是新的对象，那么一个窗口中的改变就会影响到另一个窗口）。还有一种情况：如果对象 `$foo` 中保存着对象 `$bar` 的引用，当你复制对象 `$foo` 时，你想使用的对象不再是对象 `$bar` 而是 `$bar` 的一个副本，那么你必须得到对象 `$foo` 的一个副本。

对象复制可以通过 `clone` 关键字来完成（如果可能，这将调用对象的 `__clone()` 方法）。对象中的 `__clone()` 方法不能被直接调用。

当对象被复制后， PHP 会对对象的所有属性执行一个浅复制。所有的引用属性仍然会是一个指向原来的变量的引用。

```php
<?php

declare(strict_types = 1);

class Cat
{
    /**
     * The name of cat.
     *
     * @var string
     */
    public $name;

    /**
     * The age of cat.
     *
     * @var int
     */
    public $age;

    /**
     * Store the name and age.
     *
     * @param  string $name
     * @param  int    $age
     * @return void
     */
    public function __construct(string $name, int $age)
    {
        $this->name = $name;
        $this->age = $age;
    }
}

class Dog
{
    /**
     * The name of dog.
     *
     * @var string
     */
    public $name;

    /**
     * Store an instance of cat.
     *
     * @var Cat
     */
    public $cat;
}

$spike = new Dog;
$spike->name = 'Spike';
$spike->cat = new Cat('Tom', 6);
$tyke = clone $spike;
var_dump($spike); // object(Dog)#1 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }
var_dump($tyke);  // object(Dog)#3 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }

$tyke->name = 'Tyke';
$tyke->cat->age = 2;
var_dump($spike); // object(Dog)#1 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(2) } }
var_dump($tyke);  // object(Dog)#3 (2) { ["name"]=> string(4) "Tyke" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(2) } }

```

当复制完成时，如果定义了 `__clone()` 方法，则新创建的对象（复制生成的对象）中的 `__clone()` 方法会被调用，可用于修改属性的值（如果有必要的话）。

```php
<?php

declare(strict_types = 1);

class Cat
{
    /**
     * The name of cat.
     *
     * @var string
     */
    public $name;

    /**
     * The age of cat.
     *
     * @var int
     */
    public $age;

    /**
     * Store the name and age.
     *
     * @param  string $name
     * @param  int    $age
     * @return void
     */
    public function __construct(string $name, int $age)
    {
        $this->name = $name;
        $this->age = $age;
    }
}

class Dog
{
    /**
     * The name of dog.
     *
     * @var string
     */
    public $name;

    /**
     * Store an instance of cat.
     *
     * @var Cat
     */
    public $cat;

    /**
     * Complete deep copy.
     *
     * @param  void
     * @return void
     */
    public function __clone()
    {
        $this->cat = clone $this->cat;
    }
}

$spike = new Dog;
$spike->name = 'Spike';
$spike->cat = new Cat('Tom', 6);
$tyke = clone $spike;
var_dump($spike); // object(Dog)#1 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }
var_dump($tyke);  // object(Dog)#3 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#4 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }

$tyke->name = 'Tyke';
$tyke->cat->age = 2;
var_dump($spike); // object(Dog)#1 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }
var_dump($tyke);  // object(Dog)#3 (2) { ["name"]=> string(4) "Tyke" ["cat"]=> object(Cat)#4 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(2) } }

```

可以将对象序列化后再反序列化来完成对象的深复制。

```php
<?php

declare(strict_types = 1);

class Cat
{
    /**
     * The name of cat.
     *
     * @var string
     */
    public $name;

    /**
     * The age of cat.
     *
     * @var int
     */
    public $age;

    /**
     * Store the name and age.
     *
     * @param  string $name
     * @param  int    $age
     * @return void
     */
    public function __construct(string $name, int $age)
    {
        $this->name = $name;
        $this->age = $age;
    }
}

class Dog
{
    /**
     * The name of dog.
     *
     * @var string
     */
    public $name;

    /**
     * Store an instance of cat.
     *
     * @var Cat
     */
    public $cat;
}

$spike = new Dog;
$spike->name = 'Spike';
$spike->cat = new Cat('Tom', 6);
$tyke = unserialize(serialize($spike));
var_dump($spike); // object(Dog)#1 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }
var_dump($tyke);  // object(Dog)#3 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#4 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }

$tyke->name = 'Tyke';
$tyke->cat->age = 2;
var_dump($spike); // object(Dog)#1 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }
var_dump($tyke);  // object(Dog)#3 (2) { ["name"]=> string(4) "Tyke" ["cat"]=> object(Cat)#4 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(2) } }

```

还可以将对象进行 `JSON` 编码后再解码来完成对象的深复制。

```php
<?php

declare(strict_types = 1);

class Cat
{
    /**
     * The name of cat.
     *
     * @var string
     */
    public $name;

    /**
     * The age of cat.
     *
     * @var int
     */
    public $age;

    /**
     * Store the name and age.
     *
     * @param  string $name
     * @param  int    $age
     * @return void
     */
    public function __construct(string $name, int $age)
    {
        $this->name = $name;
        $this->age = $age;
    }
}

class Dog
{
    /**
     * The name of dog.
     *
     * @var string
     */
    public $name;

    /**
     * Store an instance of cat.
     *
     * @var Cat
     */
    public $cat;
}

$spike = new Dog;
$spike->name = 'Spike';
$spike->cat = new Cat('Tom', 6);
$tyke = json_decode(json_encode($spike));
var_dump($spike); // object(Dog)#1 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }
var_dump($tyke);  // object(stdClass)#3 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(stdClass)#4 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }

$tyke->name = 'Tyke';
$tyke->cat->age = 2;
var_dump($spike); // object(Dog)#1 (2) { ["name"]=> string(5) "Spike" ["cat"]=> object(Cat)#2 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(6) } }
var_dump($tyke);  // object(stdClass)#3 (2) { ["name"]=> string(4) "Tyke" ["cat"]=> object(stdClass)#4 (2) { ["name"]=> string(3) "Tom" ["age"]=> int(2) } }

```

